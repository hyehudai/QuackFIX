# name: test/sql/read_fix.test
# description: Test read_fix table function with typed columns
# group: [sql]

require quackfix

# Test projection of specific columns
query III
SELECT MsgType, Symbol, Side FROM read_fix('testdata/sample.fix') ORDER BY MsgType, Symbol;
----
0	NULL	NULL
8	AAPL	1
8	MSFT	2
8	TSLA	1
D	AAPL	1
D	MSFT	2
W	AAPL	NULL

# Test filtering by MsgType
query I
SELECT COUNT(*) FROM read_fix('testdata/sample.fix') WHERE MsgType = 'D';
----
2

# Test filtering by MsgType and Symbol
query I
SELECT COUNT(*) FROM read_fix('testdata/sample.fix') WHERE MsgType = '8' AND Symbol = 'AAPL';
----
1

# Test projection of execution report fields
query IIII
SELECT MsgType, Symbol, ExecType, OrdStatus FROM read_fix('testdata/sample.fix') WHERE MsgType = '8' ORDER BY Symbol;
----
8	AAPL	F	2
8	MSFT	F	2
8	TSLA	F	2

# Test projection of order fields with numeric types
query IRRI
SELECT MsgType, Symbol, OrderQty, Price FROM read_fix('testdata/sample.fix') WHERE MsgType = 'D' ORDER BY Symbol;
----
D	AAPL	100.0	150.5
D	MSFT	50.0	380.25

# Test filtering by Symbol
query I
SELECT COUNT(*) FROM read_fix('testdata/sample.fix') WHERE Symbol = 'AAPL';
----
3

# Test ClOrdID field
query II
SELECT ClOrdID, Symbol FROM read_fix('testdata/sample.fix') WHERE MsgType = 'D' ORDER BY Symbol;
----
ORDER123	AAPL
ORDER456	MSFT

# Test execution fields with numeric LastQty
query IIR
SELECT OrderID, ExecID, LastQty FROM read_fix('testdata/sample.fix') WHERE MsgType = '8' ORDER BY OrderID;
----
EXEC001	TRADE001	100.0
EXEC002	TRADE002	50.0
EXEC003	TRADE003	200.0

# Test sender/target fields
query III
SELECT MsgType, SenderCompID, TargetCompID FROM read_fix('testdata/sample.fix') WHERE MsgType = 'D' LIMIT 1;
----
D	SENDER	TARGET

# Test that parse_error is NULL for valid messages
query I
SELECT COUNT(*) FROM read_fix('testdata/sample.fix') WHERE parse_error IS NULL;
----
7

# Test numeric operations - SUM
query R
SELECT SUM(OrderQty) FROM read_fix('testdata/sample.fix') WHERE MsgType = 'D';
----
150.0

# Test numeric operations - AVG
query R
SELECT AVG(Price) FROM read_fix('testdata/sample.fix') WHERE MsgType = 'D';
----
265.375

# Test numeric comparisons
query I
SELECT COUNT(*) FROM read_fix('testdata/sample.fix') WHERE Price > 200.0;
----
3

# Test MsgSeqNum as BIGINT
query I
SELECT MsgSeqNum FROM read_fix('testdata/sample.fix') WHERE MsgType = 'D' LIMIT 1;
----
1

# Test SendingTime as TIMESTAMP
query T
SELECT SendingTime FROM read_fix('testdata/sample.fix') WHERE MsgType = 'D' LIMIT 1;
----
2023-12-15 10:30:00

# Test SendingTime time operations
query I
SELECT HOUR(SendingTime) FROM read_fix('testdata/sample.fix') WHERE MsgType = 'D' LIMIT 1;
----
10

# Test tags column (Phase 5 - now populated with non-hot tags)
query I
SELECT COUNT(*) FROM read_fix('testdata/sample.fix') WHERE tags IS NOT NULL;
----
7

# Test accessing a specific tag value (tag 21 = HandlInst in message 1)
query I
SELECT tags[21] FROM read_fix('testdata/sample.fix') WHERE MsgType = 'D' LIMIT 1;
----
1

# Test accessing TransactTime (tag 60) from tags
query I
SELECT tags[60] FROM read_fix('testdata/sample.fix') WHERE MsgType = 'D' LIMIT 1;
----
20231215-10:30:00

# Test groups column (Phase 5.5 - now populated for messages with groups)
query I
SELECT COUNT(*) FROM read_fix('testdata/sample.fix') WHERE groups IS NULL;
----
5

# Test message with NoPartyIDs group (tag 453) - Message 5
query IIII
SELECT MsgType, Symbol, OrderID, ExecID FROM read_fix('testdata/sample.fix') WHERE Symbol = 'TSLA';
----
8	TSLA	EXEC003	TRADE003

# Test Market Data Snapshot message (tag 268) - Message 6
query II
SELECT MsgType, Symbol FROM read_fix('testdata/sample.fix') WHERE MsgType = 'W';
----
W	AAPL

# Test HTTP file reading from GitHub (requires httpfs extension)
# require httpfs

statement ok
INSTALL httpfs;

statement ok
LOAD httpfs;

query I
SELECT COUNT(*) FROM read_fix('https://raw.githubusercontent.com/hyehudai/QuackFIX/refs/heads/main/testdata/sample.fix');
----
6

# Test HTTP with filtering
query I
SELECT COUNT(*) FROM read_fix('https://raw.githubusercontent.com/hyehudai/QuackFIX/refs/heads/main/testdata/sample.fix') WHERE MsgType = 'D';
----
2

# Test HTTP with projection
query II
SELECT MsgType, Symbol FROM read_fix('https://raw.githubusercontent.com/hyehudai/QuackFIX/refs/heads/main/testdata/sample.fix') WHERE Symbol = 'AAPL' ORDER BY MsgType;
----
8	AAPL
D	AAPL
W	AAPL

# Phase 7.5: Test custom tags with rtags parameter (tag names)
query IT
SELECT MsgType, TransactTime FROM read_fix('testdata/sample.fix', rtags=['TransactTime']) WHERE MsgType = 'D' LIMIT 1;
----
D	20231215-10:30:00

# Test multiple rtags
query IIT
SELECT MsgType, Symbol, TransactTime FROM read_fix('testdata/sample.fix', rtags=['TransactTime']) WHERE MsgType = 'D' ORDER BY Symbol;
----
D	AAPL	20231215-10:30:00
D	MSFT	20231215-10:31:00

# Test custom tags with tagIds parameter (tag numbers)
query IT
SELECT MsgType, TransactTime FROM read_fix('testdata/sample.fix', tagIds=[60]) WHERE MsgType = 'D' LIMIT 1;
----
D	20231215-10:30:00

# Test both rtags and tagIds together
query ITT
SELECT MsgType, TransactTime, SecurityType FROM read_fix('testdata/sample.fix', rtags=['TransactTime'], tagIds=[167]) WHERE MsgType = 'D' LIMIT 1;
----
D	20231215-10:30:00	NULL

# Test empty rtags list (should work with no custom columns)
query II
SELECT MsgType, Symbol FROM read_fix('testdata/sample.fix', rtags=[]) WHERE MsgType = 'D' LIMIT 1;
----
D	AAPL

# Phase 7.9: Test prefix extraction feature

# Test prefix=false (default) - no prefix column in output
query I
SELECT COUNT(*) FROM read_fix('testdata/sample.fix', prefix=false);
----
7

# Test prefix=true adds prefix column
query I
SELECT COUNT(*) FROM read_fix('testdata/sample.fix', prefix=true);
----
7

# Test extracting prefix value from message with prefix
query ITT
SELECT MsgType, SenderCompID, prefix FROM read_fix('testdata/sample.fix', prefix=true) WHERE prefix IS NOT NULL;
----
0	TRADER	[OUT] 20240218-09:00:02.004 

# Test NULL prefix for messages without prefix
query I
SELECT COUNT(*) FROM read_fix('testdata/sample.fix', prefix=true) WHERE prefix IS NULL;
----
6

# Test counting messages with prefix
query I
SELECT COUNT(*) FROM read_fix('testdata/sample.fix', prefix=true) WHERE prefix IS NOT NULL;
----
1

# Test filtering by prefix content
query IT
SELECT MsgType, prefix FROM read_fix('testdata/sample.fix', prefix=true) WHERE prefix LIKE '[OUT]%';
----
0	[OUT] 20240218-09:00:02.004 

# Test prefix with regular columns
query IITT
SELECT MsgType, SenderCompID, TargetCompID, prefix FROM read_fix('testdata/sample.fix', prefix=true) WHERE MsgType = '0';
----
0	TRADER	EUREX	[OUT] 20240218-09:00:02.004 

# Test prefix length
query I
SELECT LENGTH(prefix) FROM read_fix('testdata/sample.fix', prefix=true) WHERE prefix IS NOT NULL;
----
28

# Test prefix with custom tags (rtags)
query ITT
SELECT MsgType, prefix, TransactTime FROM read_fix('testdata/sample.fix', prefix=true, rtags=['TransactTime']) WHERE MsgType = 'D' LIMIT 1;
----
D	NULL	20231215-10:30:00

# Test that messages without prefix still parse correctly with prefix=true
query III
SELECT MsgType, Symbol, Side FROM read_fix('testdata/sample.fix', prefix=true) WHERE MsgType = '8' ORDER BY Symbol;
----
8	AAPL	1
8	MSFT	2
8	TSLA	1

# Test prefix doesn't affect other columns
query IIRR
SELECT MsgType, Symbol, OrderQty, Price FROM read_fix('testdata/sample.fix', prefix=true) WHERE MsgType = 'D' ORDER BY Symbol;
----
D	AAPL	100.0	150.5
D	MSFT	50.0	380.25
